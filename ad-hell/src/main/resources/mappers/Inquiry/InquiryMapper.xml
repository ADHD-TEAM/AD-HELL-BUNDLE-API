<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.adhd.ad_hell.domain.inquiry.query.mapper.InquiryMapper">

    <sql id="summaryColumns">
        i.inquiry_id AS id,
        i.user_id AS userId,
        i.category_id AS categoryId,
        c.category_name AS categoryName,
        i.title AS title,
        CASE
        WHEN CHAR_LENGTH(i.contents) <= 100 THEN i.contents
        ELSE CONCAT(SUBSTRING(i.contents, 1, 100), '...')
        END AS contentsSnippet,
        CASE WHEN i.response IS NULL OR TRIM(i.response) = '' THEN 'N' ELSE 'Y' END AS answered,
        i.answered_at AS answeredAt,
        i.created_at AS createdAt
    </sql>

    <sql id="detailColumns">
        i.inquiry_id AS id,
        i.user_id AS userId,
        i.category_id AS categoryId,
        c.category_name AS categoryName,
        i.title AS title,
        i.contents AS contents,
        i.response AS response,
        CASE WHEN i.response IS NULL OR TRIM(i.response) = '' THEN 'N' ELSE 'Y' END AS answered,
        i.answered_at AS answeredAt,
        i.created_at AS createdAt
    </sql>

    <sql id="fromJoin">
        FROM inquiry i
        JOIN category c ON c.category_id = i.category_id
    </sql>

    <sql id="commonWhere">
        <where>
            <if test="req.categoryId != null">
                AND i.category_id = #{req.categoryId}
            </if>
            <if test="req.keyword != null and req.keyword != ''">
                AND (
                LOWER(i.title) LIKE CONCAT('%', LOWER(#{req.keyword}), '%')
                OR LOWER(i.contents) LIKE CONCAT('%', LOWER(#{req.keyword}), '%')
                )
            </if>
            <choose>
                <when test="req.answeredSafe() == 'Y'">
                    AND i.response IS NOT NULL AND TRIM(i.response) &lt;&gt; ''
                </when>
                <when test="req.answeredSafe() == 'N'">
                    AND (i.response IS NULL OR TRIM(i.response) = '')
                </when>
            </choose>
        </where>
    </sql>

    <sql id="orderBy">
        ORDER BY
        <choose>
            <when test="req.sortBySafe() == 'answeredAt'"> i.answered_at </when>
            <when test="req.sortBySafe() == 'title'"> i.title </when>
            <otherwise> i.created_at </otherwise>
        </choose>
        ${req.directionSafe()}
    </sql>

    <!-- 회원 목록 -->
    <select id="findMyInquiries" resultType="com.adhd.ad_hell.domain.inquiry.query.dto.response.InquirySummaryResponse">
        SELECT <include refid="summaryColumns"/>
        <include refid="fromJoin"/>
        WHERE i.user_id = #{req.userId}
        <include refid="commonWhere"/>
        <include refid="orderBy"/>
        LIMIT #{req.size} OFFSET #{req.offset}
    </select>

    <select id="countMyInquiries" resultType="int">
        SELECT COUNT(1)
        <include refid="fromJoin"/>
        WHERE i.user_id = #{req.userId}
        <include refid="commonWhere"/>
    </select>

    <select id="findMyInquiryById" resultType="com.adhd.ad_hell.domain.inquiry.query.dto.response.InquiryDetailResponse">
        SELECT <include refid="detailColumns"/>
        <include refid="fromJoin"/>
        WHERE i.inquiry_id = #{id} AND i.user_id = #{userId}
        LIMIT 1
    </select>

    <!-- 관리자 -->
    <select id="findAdminInquiries" resultType="com.adhd.ad_hell.domain.inquiry.query.dto.response.InquirySummaryResponse">
        SELECT <include refid="summaryColumns"/>
        <include refid="fromJoin"/>
        <include refid="commonWhere"/>
        <include refid="orderBy"/>
        LIMIT #{req.size} OFFSET #{req.offset}
    </select>

    <select id="countAdminInquiries" resultType="int">
        SELECT COUNT(1)
        <include refid="fromJoin"/>
        <include refid="commonWhere"/>
    </select>

    <select id="findAdminInquiryById" resultType="com.adhd.ad_hell.domain.inquiry.query.dto.response.InquiryDetailResponse">
        SELECT <include refid="detailColumns"/>
        <include refid="fromJoin"/>
        WHERE i.inquiry_id = #{id}
        LIMIT 1
    </select>
</mapper>
